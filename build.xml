<!-- This is an ant makefile, type "ant" to run it -->
<project name="jnisat" default="build" xmlns:if="ant:if">
	<target name="clean" description="removes all build artifacts">
		<delete includeEmptyDirs="true" dir="build" />
	</target>

	<target name="compile">
		<mkdir dir="build" />
		<javac srcdir="src" destdir="build" includeantruntime="false">
			<classpath>
				<pathelement path="build" />
				<pathelement location="lib/org.sat4j.core.jar" />
			</classpath>
		</javac>
		<javah destdir="build" force="yes" classpath="build">
			<class name="jnisat.JPicoSat" />
			<class name="jnisat.JMiniSat" />
			<class name="jnisat.COMiniSatPS" />
		</javah>
	</target>

	<target name="build" depends="compile" description="builds the jnisat.jar file">
		<jar destfile="jnisat.jar" includes="" compress="true">
			<fileset dir="src" includes="**/*.java" />
			<fileset dir="build" includes="**/*.class" />
			<fileset dir="" includes="lib/**/*.so" />
			<fileset dir="" includes="lib/**/*.dll" />
			<zipfileset src="lib/org.sat4j.core.jar">
				<include name="org/**/*" />
			</zipfileset>
			<fileset file="LICENSE" />
			<fileset file="README.md" />
			<manifest>
				<attribute name="Main-Class" value="jnisat.Validate" />
				<attribute name="Class-Path" value="." />
			</manifest>
		</jar>
	</target>

	<target name="libdir" depends="compile">
		<java classname="jnisat.LibDetect" classpath="build" outputproperty="jnisat.libdir" failonerror="true">
			<arg value="libdir" />
		</java>
		<mkdir dir="build/${jnisat.libdir}" />
		<condition property="jnisat.win32">
			<equals arg1="${jnisat.libdir}" arg2="win32" />
		</condition>
		<condition property="jnisat.win64">
			<equals arg1="${jnisat.libdir}" arg2="win64" />
		</condition>
	</target>

	<target name="jpicosat" depends="libdir" description="compiles the jpicosat adapter">
		<java classname="jnisat.LibDetect" classpath="build" outputproperty="jnisat.jpicosat" failonerror="true">
			<arg value="libname" />
			<arg value="jpicosat" />
		</java>
		<exec executable="gcc" os="Linux" dir="build" failonerror="true">
			<arg value="-Wall" />
			<arg value="-O3" />
			<arg value="-fPIC" />
			<arg value="-shared" />
			<arg value="-s" />
			<arg value="-I${java.home}/../include/" />
			<arg value="-I${java.home}/../include/linux/" />
			<arg value="-I." />
			<arg value="../src/jnisat/JPicoSat.c" />
			<arg value="-lpicosat" />
			<arg value="-o" />
			<arg value="${jnisat.jpicosat}" />
		</exec>
		<move file="build/${jnisat.jpicosat}" todir="lib/${jnisat.libdir}" />
	</target>

	<target name="minisat.src">
		<condition property="minisat.src">
			<available file="build/minisat-master" type="dir" />
		</condition>
	</target>

	<target name="getminisat" depends="minisat.src" unless="minisat.src">
		<mkdir dir="build" />
		<exec executable="curl" dir="build" failonerror="true">
			<arg value="-L" />
			<arg value="https://github.com/niklasso/minisat/archive/master.zip" />
			<arg value="-o" />
			<arg value="minisat-master.zip" />
		</exec>
		<exec executable="unzip" dir="build" failonerror="true">
			<arg value="minisat-master.zip" />
		</exec>
		<exec executable="patch" dir="build/minisat-master" failonerror="true">
			<arg value="-p0" />
			<arg value="-i" />
			<arg value="../../src/minisat.patch" />
		</exec>
	</target>

	<target name="jminisat" depends="libdir" description="compiles the jminisat adapter">
		<java classname="jnisat.LibDetect" classpath="build" outputproperty="jnisat.jminisat" failonerror="true">
			<arg value="libname" />
			<arg value="jminisat" />
		</java>
		<exec executable="g++" os="Linux" dir="build" failonerror="true">
			<arg value="-Wall" />
			<arg value="-O3" />
			<arg value="-fPIC" />
			<arg value="-shared" />
			<arg value="-s" />
			<arg value="-I${java.home}/../include/" />
			<arg value="-I${java.home}/../include/linux/" />
			<arg value="-I." />
			<arg value="../src/jnisat/JMiniSat.cpp" />
			<arg value="-lminisat" />
			<arg value="-o" />
			<arg value="${jnisat.jminisat}" />
		</exec>
		<antcall if:set="jnisat.win64" target="getminisat" />
		<exec executable="i686-pc-mingw32-g++" if:set="jnisat.win32" dir="build" failonerror="true">
			<arg value="-D __STDC_LIMIT_MACROS" />
			<arg value="-D __STDC_FORMAT_MACROS" />
			<arg value="-D NDEBUG" />
			<arg value="-Wall" />
			<arg value="-O3" />
			<arg value="-shared" />
			<arg value="-static-libgcc" />
			<arg value="-static-libstdc++" />
			<arg value="-s" />
			<arg value="-I${java.home}/../include/" />
			<arg value="-I${java.home}/../include/win32/" />
			<arg value="-Iminisat-master/" />
			<arg value="-I." />
			<arg value="../src/jnisat/JMiniSat.cpp" />
			<arg value="minisat-master/minisat/utils/System.cc" />
			<arg value="minisat-master/minisat/core/Solver.cc" />
			<arg value="minisat-master/minisat/simp/SimpSolver.cc" />
			<arg value="-o" />
			<arg value="${jnisat.jminisat}" />
			<arg value="-Wl,--kill-at" />
		</exec>
		<exec executable="x86_64-w64-mingw32-g++" if:set="jnisat.win64" dir="build" failonerror="true">
			<arg value="-D __USE_MINGW_ANSI_STDIO" />
			<arg value="-D __STDC_LIMIT_MACROS" />
			<arg value="-D __STDC_FORMAT_MACROS" />
			<arg value="-D NDEBUG" />
			<arg value="-Wall" />
			<arg value="-O3" />
			<arg value="-shared" />
			<arg value="-static-libgcc" />
			<arg value="-static-libstdc++" />
			<arg value="-s" />
			<arg value="-I${java.home}/../include/" />
			<arg value="-I${java.home}/../include/win32/" />
			<arg value="-Iminisat-master/" />
			<arg value="-I." />
			<arg value="../src/jnisat/JMiniSat.cpp" />
			<arg value="minisat-master/minisat/utils/System.cc" />
			<arg value="minisat-master/minisat/core/Solver.cc" />
			<arg value="minisat-master/minisat/simp/SimpSolver.cc" />
			<arg value="-o" />
			<arg value="${jnisat.jminisat}" />
			<arg value="-Wl,--kill-at" />
		</exec>
		<move file="build/${jnisat.jminisat}" todir="lib/${jnisat.libdir}" />
	</target>

	<target name="cominisatps" depends="libdir" description="compiles the COMiniSatPS solver">
		<java classname="jnisat.LibDetect" classpath="build" outputproperty="jnisat.cominisatps" failonerror="true">
			<arg value="libname" />
			<arg value="cominisatps" />
		</java>
		<exec executable="g++" os="Linux" dir="build" failonerror="true">
			<arg value="-Wall" />
			<arg value="-Wno-parentheses" />
			<arg value="-Wno-unused-label" />
			<arg value="-Wno-unused-function" />
			<arg value="-O3" />
			<arg value="-fPIC" />
			<arg value="-shared" />
			<arg value="-s" />
			<arg value="-I${java.home}/../include/" />
			<arg value="-I${java.home}/../include/linux/" />
			<arg value="-I." />
			<arg value="-I../solvers/COMiniSatPS" />
			<arg value="../src/jnisat/COMiniSatPS.cpp" />
			<arg value="../solvers/COMiniSatPS/utils/System.cc" />
			<arg value="../solvers/COMiniSatPS/core/Solver.cc" />
			<arg value="../solvers/COMiniSatPS/simp/SimpSolver.cc" />
			<arg value="-o" />
			<arg value="${jnisat.cominisatps}" />
		</exec>
		<move file="build/${jnisat.cominisatps}" todir="lib/${jnisat.libdir}" />
	</target>

	<target name="detect" depends="build">
		<echo message="ant os.arch: ${os.arch}" />
		<echo message="ant os.name: ${os.name}" />
		<echo message="ant java.home: ${java.home}" />
		<java classname="jnisat.LibDetect" classpath="jnisat.jar" fork="true" failonerror="true"/>
	</target>

	<target name="validate" depends="detect" description="runs the validation program">
		<java jar="jnisat.jar" fork="true" failonerror="true">
			<jvmarg value="-ea" />
		</java>
	</target>

	<target name="travis" depends="validate" />

</project>
