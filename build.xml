<!-- This is an ant makefile, type "ant" to run it -->
<project name="jnisat" default="jar">
	<target name="clean" description="removes all build artifacts">
		<delete includeEmptyDirs="true">
			<fileset dir="build" includes="**/*" />
		</delete>
	</target>

	<target name="build" description="compiles the java files">
		<mkdir dir="build" />
		<javac srcdir="src" destdir="build" classpath="build" includeantruntime="false" />
		<javah destdir="build" force="yes" classpath="build">
			<class name="jnisat.JPicoSat" />
			<class name="jnisat.JMiniSat" />
		</javah>
	</target>

	<target name="detect" depends="build">
		<echo message="os.name: ${os.name}" />
		<echo message="os.arch: ${os.arch}" />
		<java classname="jnisat.LibDetect" classpath="build" outputproperty="jnisat.suffix">
			<arg value="suffix" />
		</java>
		<echo message="jnisat.suffix: ${jnisat.suffix}" />
		<java classname="jnisat.LibDetect" classpath="build" outputproperty="jnisat.picosat" fork="true">
			<arg value="testlib" />
			<arg value="picosat" />
		</java>
		<echo message="jnisat.picosat: ${jnisat.picosat}" />
		<java classname="jnisat.LibDetect" classpath="build" outputproperty="jnisat.minisat" fork="true">
			<arg value="testlib" />
			<arg value="minisat" />
		</java>
		<echo message="jnisat.minisat: ${jnisat.minisat}" />
	</target>

	<target name="picosat" depends="detect" description="compiles the jpicosat library">
		<exec executable="gcc" os="Linux" dir="build" failonerror="true">
			<arg value="-Wall" />
			<arg value="-O3" />
			<arg value="-fPIC" />
			<arg value="-shared" />
			<arg value="-I${java.home}/../include/" />
			<arg value="-I${java.home}/../include/linux/" />
			<arg value="-I." />
			<arg value="../src/jnisat/JPicoSat.c" />
			<arg value="-lpicosat" />
			<arg value="-o" />
			<arg value="jpicosat-${jnisat.suffix}" />
		</exec>
		<move file="build/jpicosat-${jnisat.suffix}" todir="lib" />
	</target>

	<target name="minisat" depends="detect" description="compiles the jpicosat library">
		<exec executable="g++" os="Linux" dir="build" failonerror="true">
			<arg value="-Wall" />
			<arg value="-O3" />
			<arg value="-fPIC" />
			<arg value="-shared" />
			<arg value="-I${java.home}/../include/" />
			<arg value="-I${java.home}/../include/linux/" />
			<arg value="-I." />
			<arg value="../src/jnisat/JMiniSat.cpp" />
			<arg value="-lminisat" />
			<arg value="-o" />
			<arg value="jminisat-${jnisat.suffix}" />
		</exec>
		<move file="build/jminisat-${jnisat.suffix}" todir="lib" />
	</target>

	<target name="jar" depends="build" description="builds the jnisat.jar file">
		<jar destfile="jnisat.jar" includes="" compress="true">
			<fileset dir="build" includes="**/*.class" />
			<fileset dir="lib" includes="*.so" />
			<fileset file="LICENSE" />
			<fileset file="README.md" />
			<manifest>
				<attribute name="Main-Class" value="jnisat.Validate" />
				<attribute name="Class-Path" value="." />
			</manifest>
		</jar>
	</target>

	<target name="validate" depends="jar" description="runs the validation program">
		<java jar="jnisat.jar" fork="true">
			<jvmarg value="-ea" />
		</java>
	</target>

</project>
